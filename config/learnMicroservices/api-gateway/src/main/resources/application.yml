# API Gateway Configuration
# Spring Cloud Gateway acts as the single entry point for all client requests
# It routes requests to appropriate microservices based on path patterns

spring:
  application:
    name: api-gateway
  
  # Cloud Gateway Configuration
  cloud:
    gateway:
      # Enable the gateway
      enabled: true
      
      # Routes definition
      # 
      # ROUTING STRATEGY:
      # -----------------
      # App A has TWO controllers:
      #   1. AppAController:       @RequestMapping("") - Maps to root /
      #   2. ResilienceController: @RequestMapping("/api/resilience") - Maps to /api/resilience
      # 
      # Gateway routes:
      #   - /api/app-a/** (except /api/app-a/api/resilience/**) → Strip /api/app-a → Forward to AppAController
      #   - /api/app-a/api/resilience/** → Strip /api/app-a → Forward to ResilienceController
      #
      routes:
        # ============================================================
        # APP A ROUTE - Handles ALL App A endpoints
        # ============================================================
        # Matches:
        #   /api/app-a/greeting/{name}           → /greeting/{name}
        #   /api/app-a/status                    → /status
        #   /api/app-a/call-app-b/**             → /call-app-b/**
        #   /api/app-a/api/resilience/**         → /api/resilience/** (NEW - Phase 4)
        #
        - id: app-a-route
          uri: lb://app-a
          predicates:
            - Path=/api/app-a/**
          filters:
            # Remove /api/app-a prefix and forward the rest to service
            # Example 1: /api/app-a/greeting/John → /greeting/John (AppAController)
            # Example 2: /api/app-a/api/resilience/app-b/status → /api/resilience/app-b/status (ResilienceController)
            - RewritePath=/api/app-a(?<segment>/?.*), $\{segment}
            # Add tracking headers
            - AddRequestHeader=X-Gateway-Route,app-a
            - AddResponseHeader=X-Gateway-Response,true
        
        # ============================================================
        # APP B ROUTE - Handles ALL App B endpoints
        # ============================================================
        # Matches:
        #   /api/app-b/product/{id}
        #   /api/app-b/health
        #   /api/app-b/status
        #   /api/app-b/greeting/{name}
        #   /api/app-b/call-app-a/**
        #   /api/app-b/** (any other endpoint)
        #
        - id: app-b-route
          uri: lb://app-b
          predicates:
            - Path=/api/app-b/**
          filters:
            # Remove /api/app-b prefix and forward the rest to service
            # Example: /api/app-b/product/101 → /product/101
            - RewritePath=/api/app-b(?<segment>/?.*), $\{segment}
            # Add tracking headers
            - AddRequestHeader=X-Gateway-Route,app-b
            - AddResponseHeader=X-Gateway-Response,true
      
      # Global filters (applied to all routes)
      globalcors:
        corsConfigurations:
          '[/**]':
            allowedOrigins: "*"
            allowedMethods: "*"
            allowedHeaders: "*"
            allowCredentials: false
            maxAge: 3600
  
  # ===== DISTRIBUTED TRACING CONFIGURATION (Phase 3) =====
  sleuth:
    enabled: true
    sampler:
      probability: 1.0  # Sample 100% of requests (for learning)
  
  # Enable trace ID propagation in HTTP headers (B3 format)
  # This sends trace ID to backend services via HTTP headers
  tracing:
    propagation:
      type: b3

# Server Configuration
server:
  port: 9002
  servlet:
    context-path: /

# Eureka Client Configuration
eureka:
  client:
    service-url:
      defaultZone: http://localhost:8761/eureka/
    # Register this gateway with Eureka
    register-with-eureka: true
    # Fetch service registry from Eureka
    fetch-registry: true
    # Enable service discovery
    enabled: true
  
  instance:
    # Service name in Eureka
    appname: api-gateway
    instance-id: ${spring.application.name}:${server.port}
    # Use IP address instead of hostname
    prefer-ip-address: true
    ip-address: 127.0.0.1
    # Enable health check endpoint
    health-check-url-path: /actuator/health
    # Home page URL
    home-page-url: http://127.0.0.1:9002/
    # Status page URL
    status-page-url-path: /actuator/health

# Management Endpoints Configuration
management:
  endpoints:
    web:
      exposure:
        # Expose health, info, and gateway endpoints
        include: health,info,gateway,env,configprops
      base-path: /actuator
  
  endpoint:
    health:
      show-details: always
    gateway:
      enabled: true

# Logging Configuration
logging:
  level:
    root: INFO
    org.springframework.cloud.gateway: DEBUG
    org.springframework.cloud.loadbalancer: DEBUG
    org.springframework.web: DEBUG
    com.masterclass: DEBUG
  pattern:
    console: "%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - [TRACE: %X{traceId}] %msg%n"

# Info Endpoint Configuration
info:
  app:
    name: API Gateway
    description: Spring Cloud API Gateway for routing and managing traffic
    version: 1.0.0
    author: Microservices Masterclass
  gateway:
    total-routes: 2
    routing-strategy: Catch-all with unique prefixes (Best Practice)
    services: app-a, app-b
    port: 9002
    discovery: Eureka
  phase-4:
    resilience-enabled: true
    note: All App A endpoints automatically routed, including resilience endpoints
