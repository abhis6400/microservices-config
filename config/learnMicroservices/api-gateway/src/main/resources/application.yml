# API Gateway Configuration
# Spring Cloud Gateway acts as the single entry point for all client requests
# It routes requests to appropriate microservices based on path patterns

spring:
  application:
    name: api-gateway
  
  # Cloud Gateway Configuration
  cloud:
    gateway:
      # Enable the gateway
      enabled: true
      
      # Routes definition
      routes:
        # Route to App A
        - id: app-a-route
          uri: lb://app-a
          predicates:
            # Match requests to /api/app-a/**
            - Path=/api/app-a/**
          filters:
            # Remove /api/app-a prefix and forward to /
            - RewritePath=/api/app-a(?<segment>/?.*), $\{segment}
            # Add custom header to track request origin
            - AddRequestHeader=X-Gateway-Route,app-a
            # Add response header with execution time
            - AddResponseHeader=X-Gateway-Response,true
        
        # Route to App B
        - id: app-b-route
          uri: lb://app-b
          predicates:
            # Match requests to /api/app-b/**
            - Path=/api/app-b/**
          filters:
            # Remove /api/app-b prefix and forward to /
            - RewritePath=/api/app-b(?<segment>/?.*), $\{segment}
            # Add custom header to track request origin
            - AddRequestHeader=X-Gateway-Route,app-b
            # Add response header with execution time
            - AddResponseHeader=X-Gateway-Response,true
      
      # Global filters (applied to all routes)
      globalcors:
        corsConfigurations:
          '[/**]':
            allowedOrigins: "*"
            allowedMethods: "*"
            allowedHeaders: "*"
            allowCredentials: false
            maxAge: 3600

# Server Configuration
server:
  port: 9002
  servlet:
    context-path: /

# Eureka Client Configuration
eureka:
  client:
    service-url:
      defaultZone: http://localhost:8761/eureka/
    # Register this gateway with Eureka
    register-with-eureka: true
    # Fetch service registry from Eureka
    fetch-registry: true
    # Enable service discovery
    enabled: true
  
  instance:
    # Service name in Eureka
    appname: api-gateway
    instance-id: ${spring.application.name}:${server.port}
    # Use IP address instead of hostname
    prefer-ip-address: true
    ip-address: 127.0.0.1
    # Enable health check endpoint
    health-check-url-path: /actuator/health
    # Home page URL
    home-page-url: http://127.0.0.1:9002/
    # Status page URL
    status-page-url-path: /actuator/health

# Management Endpoints Configuration
management:
  endpoints:
    web:
      exposure:
        # Expose health, info, and gateway endpoints
        include: health,info,gateway,env,configprops
      base-path: /actuator
  
  endpoint:
    health:
      show-details: always
    gateway:
      enabled: true

# Logging Configuration
logging:
  level:
    root: INFO
    org.springframework.cloud.gateway: DEBUG
    org.springframework.cloud.loadbalancer: DEBUG
    org.springframework.web: DEBUG
    com.masterclass: DEBUG
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"

# Info Endpoint Configuration
info:
  app:
    name: API Gateway
    description: Spring Cloud API Gateway for routing and managing traffic
    version: 1.0.0
    author: Microservices Masterclass
  gateway:
    routes: 2
    services: app-a, app-b
    port: 9002
    discovery: Eureka
